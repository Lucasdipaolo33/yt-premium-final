<script>
    // Registro del Service Worker
    if ('serviceWorker' in navigator) { 
        navigator.serviceWorker.register('sw.js'); 
    }

    let deferredPrompt;
    const installArea = document.getElementById('install-area');
    const loader = document.getElementById('loader');
    const btnInstalar = document.getElementById('btnInstalar');

    // ESTO ES LO QUE ARREGLA EL BOTÓN: Captura el evento globalmente
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e; // Guardamos el evento para usarlo después
        loader.style.display = 'none';
        installArea.style.display = 'block';
        console.log("Evento de instalación capturado");
    });

    // Acción del botón
    btnInstalar.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt(); // Muestra el cartel oficial de instalación
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                deferredPrompt = null;
                location.reload();
            }
        } else {
            // Si el navegador se pone terco, intentamos forzarlo así:
            alert("El navegador está verificando la seguridad. Si no aparece el cartel, usa: 'Instalar' en el menú de los 3 puntos.");
        }
    });

    // Si ya está instalado, redirigir a YouTube
    const isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    if (isPWA) {
        // Trucos de segundo plano y bloqueo
        Object.defineProperty(document, 'visibilityState', {get: () => 'visible'});
        Object.defineProperty(document, 'hidden', {get: () => false});
        window.location.replace("https://m.youtube.com/?persist_gl=1&gl=AR");
        
        // Motor de bloqueo (Lógica de la extensión que pasaste)
        setInterval(() => {
            const v = document.querySelector('video');
            if (document.querySelector('.ad-showing, .ad-interrupting') && v) {
                v.muted = true;
                if (isFinite(v.duration)) v.currentTime = v.duration;
                v.playbackRate = 16;
                document.querySelector('.ytp-ad-skip-button, .ytp-ad-skip-button-modern')?.click();
            }
            document.querySelectorAll('ytm-promoted-video-renderer, ytm-display-ad-renderer, ytm-ad-slot, .ad-container').forEach(el => el.remove());
        }, 250);
    } else {
        // Respaldo visual: si a los 2 segundos no se capturó el evento, mostramos el botón igual
        setTimeout(() => {
            loader.style.display = 'none';
            installArea.style.display = 'block';
        }, 2000);
    }
</script>
