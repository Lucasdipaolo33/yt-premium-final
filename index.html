<script>
    // 1. Registro del Service Worker (Fundamental para el botón)
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }

    let deferredPrompt;
    const btnInstalar = document.getElementById('btnInstalar');

    // 2. Capturar el evento de instalación
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        console.log("Evento de instalación capturado");
    });

    // 3. Acción del botón (Ahora más seguro)
    btnInstalar.onclick = () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choice) => {
                if (choice.outcome === 'accepted') {
                    deferredPrompt = null;
                }
            });
        } else {
            alert("Para instalar, usa el menú de tres puntos de tu navegador o espera a que cargue el sistema.");
        }
    };

    // 4. EL DETECTOR DE APP (Para evitar el bucle de ayer)
    // Si entramos con el parámetro ?mode=pwa o ya estamos en standalone:
    const urlParams = new URLSearchParams(window.location.search);
    if (window.matchMedia('(display-mode: standalone)').matches || urlParams.get('mode') === 'pwa') {
        
        // Bloqueador de visibilidad (para segundo plano)
        Object.defineProperty(document, 'visibilityState', {get: () => 'visible'});
        Object.defineProperty(document, 'hidden', {get: () => false});

        // VAMOS A YOUTUBE (El login funcionará normal porque es redirección directa)
        window.location.replace("https://m.youtube.com/?persist_gl=1&gl=AR");
    }
</script>
